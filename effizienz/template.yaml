- sensor:
# Wirkunsgrad Sensoren Tag
    - name: "Solarflow DC→AC Wirkungsgrad Day"
      unique_id: sf_dc_ac_wirkungsgrad_daily
      unit_of_measurement: "%"
      state: >
        {% set dc = states('sensor.sf_dc_haus_heute')|float(0) %}
        {% set ac = states('sensor.sf_ac_haus_heute')|float(0) %}
        {% if dc > 0 %}
          {{ (ac / dc * 100) | round(1) }}
        {% else %}
          0
        {% endif %} 
    - name: "Solarflow PV→AC Systemwirkungsgrad Day"
      unique_id: sf_pv_ac_system_wirkungsgrad_daily
      unit_of_measurement: "%"
      state: >
        {% set laden = states('sensor.sf_akku_laden_heute')|float(0) %}
        {% set entladen = states('sensor.sf_akku_entladen_heute')|float(0) %}  
        {% set pv = states('sensor.sf_pv_gesamt_heute')|float(0) %}
        {% set ac = states('sensor.sf_ac_haus_heute')|float(0) %}
        {% if (pv + entladen - laden) > 0 %}
          {{ (ac / (pv +entladen - laden) * 100) | round(1) }}
        {% else %}
          0
        {% endif %}

# Wirkunsgrad Sensoren Monat        
    - name: "Solarflow DC→AC Wirkungsgrad Month"
      unique_id: sf_dc_ac_wirkungsgrad_monthly
      unit_of_measurement: "%"
      state: >
        {% set dc = states('sensor.monthly_output_home_energy')|float(0)|round(2) %}
        {% set ac = states('sensor.monthly_ac_power_home_energy')|float(0)|round(2) %}
        {% if dc > 0 %}
          {{ (ac / dc * 100) | round(1) }}
        {% else %}
          0
        {% endif %} 
    - name: "Solarflow PV→AC Systemwirkungsgrad Month"
      unique_id: sf_pv_ac_system_wirkungsgrad_monthly
      state_class: measurement
      unit_of_measurement: "%"
      state: >
        {% set laden = states('sensor.monthly_charging_energy')|float(0)|round(2) %}
        {% set entladen = states('sensor.monthly_discharging_energy')|float(0)|round(2) %}  
        {% set pv = states('sensor.monthly_solarpower_energy')|float(0)|round(2) %}
        {% set ac = states('sensor.monthly_ac_power_home_energy')|float(0)|round(2) %}
        {% if (pv + entladen - laden)  > 0 %}
          {{ (ac / (pv + entladen - laden) * 100) | round(1) }}
        {% else %}
          0
        {% endif %} 

# Sensoren für Scatter Chart Diagramme
- trigger:
  - platform: time_pattern
    minutes: 59
  sensor:
    - name: "Solarflow Stundendaten"
      unique_id: sf_pv_ac_system_wirkungsgrad_hourly_scatter
      unit_of_measurement: "%"
      state_class: measurement
      state: >
        {{ states('sensor.solarflow_pv_ac_systemwirkungsgrad_hour') | float(0) }}


- trigger:
    - platform: time_pattern
      minutes: 59
  sensor:
    - name: "Solarflow AC Energie Stunde"
      unique_id: sf_ac_energy_hourly_scatter
      state_class: measurement
      unit_of_measurement: "Wh"
      state: >
        {{ states('sensor.hourly_ac_power_home_energy') | float(0) * 1000 }}

- trigger:
  - platform: time
    at: "23:59:00"
  sensor:
    - name: "Solarflow Tagesdaten"
      unique_id: sf_pv_ac_system_wirkungsgrad_daily_scatter
      state:  > 
        {{ states('sensor.solarflow_pv_ac_systemwirkungsgrad_day')| float(0)}}
      unit_of_measurement: "%"
      state_class: measurement

- trigger:
    - platform: time
      at: "23:59:00" 
  sensor:
    - name: "Solarflow AC Energie Tag"
      unique_id: sf_ac_energy_daily_scatter
      state_class: measurement
      unit_of_measurement: "Wh"
      state: >
        {{ states('sensor.sf_ac_haus_heute') | float(0) * 1000 }}
