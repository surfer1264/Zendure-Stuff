// ========== AkkuVolt Watchdog mit Signal-Benachrichtigungen ==========
// Erkennt Akku-Zustand und sendet Nachrichten bei:
//  - Akku voll (>= 99 %)
//  - Unterspannung einzelner Zellen (< 3.0 V)

print("âš¡ Starte AkkuVolt-Watchdog â€” bitte vorsichtig benutzen!");

// ==================== EINSTELLUNGEN ====================

// MQTT-Topic deines BMS oder Gateways:
let mqttTopic   = "MYAppKEY/#";

// Signal (CallMeBot) Einstellungen:
let signalPhone = "PHONE-STRING";    // z. B. +4917XXXXXXXX
let signalKey   = "YOUR_API_KEY";    // dein API Key

// Schwellwerte:
let vollSchwelle = 99;               // Prozent, ab wann Akku als â€žvollâ€œ gilt
let entladeReset = 90;               // Prozent, ab wann erneute Vollmeldung erlaubt ist
let minVoltWarn  = 3.0;              // Volt, Unterspannungsgrenze
let minVoltReset = 3.1;              // Volt, Erholungsgrenze zum ZurÃ¼cksetzen der Warnung

// ==================== VARIABLEN ====================
let Zen = 1;                         // Gesamt-Ladezustand
let bat = 9;                         // Akku-Arbeitsmodus
let modus = "OPEN ";                 // Textdarstellung Modus
let packs = {};                      // Datenstruktur fÃ¼r alle Zellen

// Flags fÃ¼r Nachrichten
let akkuVollMsgSent = false;         // ob Akku-Vollmeldung bereits gesendet wurde
let lowVoltMsgSent = {};             // Objekt: pro Zelle merken, ob Unterspannungswarnung gesendet wurde

// ==================== HILFSFUNKTIONEN ====================

// Signal-Nachricht senden:
function sendSignalMessage(text) {
	let url = "https://api.callmebot.com/signal/send.php" +
			  "?phone=" + signalPhone +
			  "&apikey=" + signalKey +
			  "&text=" + text;

	print("ðŸ“¨ Sende Signal-Nachricht: " + url);

	Shelly.call("HTTP.GET", { url: url }, function (result, error_code, error_msg) {
		if (error_code === 0) {
			print("âœ… Nachricht erfolgreich gesendet.");
		} else {
			print("âŒ Fehler beim Senden: " + error_msg);
		}
	});
}

// Ausgabe eines einzelnen Akkus:
function Druck(sn) {
	let daten = packs[sn];
	if (!daten) return;
	print(modus +
		  sn + ": " +
		  (daten.soc !== undefined ? daten.soc + "%" : "-%") + " " +
		  (daten.minV !== undefined ? daten.minV + "V" : "-V") + " .. " +
		  (daten.maxV !== undefined ? daten.maxV + "V" : "-V") + " " +
		  (daten.maxT !== undefined ? daten.maxT + "Â°" : "-Â°"));
}

// Ausgabe aller Akkus:
function DruckAlle() {
	for (let sn in packs) {
		Druck(sn);
	}
}

// ==================== MQTT HANDLER ====================

MQTT.subscribe(mqttTopic, function (topic, msg) {
	let data = JSON.parse(msg);

	// --- PACKDATEN ---
	if (data.packData) {
		for (let i = 0; i < data.packData.length; i++) {
			let pack = data.packData[i];
			let sn = pack.sn;

			if (!packs[sn]) {
				packs[sn] = { soc: undefined, minV: undefined, maxV: undefined, maxT: undefined };
				lowVoltMsgSent[sn] = false; // pro Zelle initialisieren
			}

			// Werte Ã¼bernehmen
			if (pack.maxVol !== undefined) packs[sn].maxV = pack.maxVol / 100;
			if (pack.minVol !== undefined) {
				packs[sn].minV = pack.minVol / 100;

				// --- Unterspannung prÃ¼fen ---
				if (packs[sn].minV < minVoltWarn) {
					if (!lowVoltMsgSent[sn]) {
						lowVoltMsgSent[sn] = true;
						sendSignalMessage("Zelle_" + sn + "hat_nur_" + packs[sn].minV + "_V!");
					}
				} else if (packs[sn].minV > minVoltReset) {
					lowVoltMsgSent[sn] = false;
				}
			}
			if (pack.maxTemp !== undefined) packs[sn].maxT = pack.maxTemp - 273.1;
			if (pack.socLevel !== undefined) packs[sn].soc = pack.socLevel;

			Druck(sn);
		}
	}

	// --- PACKZUSTAND ---
	if (data.packState !== undefined) {
		if (bat !== data.packState) {
			bat = data.packState;
			switch (bat) {
				case 0: modus = "STBY "; break;
				case 1: modus = "LOAD "; break;
				case 2: modus = "UNLD "; break;
			}
			DruckAlle();
		}
	}

	// --- GESAMTLADEZUSTAND ---
	if (data.electricLevel !== undefined) {
		if (Zen !== data.electricLevel) {
			Zen = data.electricLevel;
			DruckAlle();

			if (Zen >= vollSchwelle) {
				if (!akkuVollMsgSent) {
					akkuVollMsgSent = true;
					sendSignalMessage("Akku_ist_jetzt_voll_(" + Zen + "%)");
				}
			} else if (Zen < entladeReset) {
				akkuVollMsgSent = false;
			}
		}
	}
});

print("ðŸ“¡ MQTT-Ãœberwachung aktiv auf Topic:", mqttTopic);
//Test einer Nachricht
//sendSignalMessage("ONLY_A_TEST_Akku_ist_jetzt_voll_(" + Zen + "%)");
