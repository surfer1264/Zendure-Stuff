// ========== AkkuVolt + HyperTemp Watchdog mit Signal-Benachrichtigungen ==========
// Erkennt Akku-Zustand und Hyper-Temperatur und sendet Nachrichten bei:
//  - Akku voll (>= 99 %)
//  - Unterspannung einzelner Zellen (< 3.0 V)
//  - Ãœbertemperatur (HyperTemp > 40 Â°C, Reset < 30 Â°C)

print("âš¡ Starte AkkuVolt + HyperTemp Watchdog â€” bitte vorsichtig benutzen!");

// ==================== EINSTELLUNGEN ====================

// MQTT-Topic deines BMS oder Gateways:
let mqttTopic   = "MYAppKEY/#";

// Signal (CallMeBot) Einstellungen:
let signalPhone = "PHONE-STRING";    // z. B. +4917XXXXXXXX
let signalKey   = "YOUR_API_KEY";    // dein API Key


// Schwellwerte:
let vollSchwelle = 99;               // Prozent, ab wann Akku als â€žvollâ€œ gilt
let entladeReset = 95;               // Prozent, ab wann erneute Vollmeldung erlaubt ist
let minVoltWarn  = 3.0;              // Volt, Unterspannungsgrenze
let minVoltReset = 3.1;              // Volt, Erholungsgrenze zum ZurÃ¼cksetzen der Warnung
let tempWarn     = 40.0;             // Â°C, Temperaturgrenze fÃ¼r Alarm
let tempReset    = 30.0;             // Â°C, Grenze fÃ¼r RÃ¼cksetzen der Warnung

// ==================== VARIABLEN ====================
let Zen = 0;                         // Gesamt-Ladezustand
let bat = 9;                         // Akku-Arbeitsmodus
let modus = "OPEN ";                 // Textdarstellung Modus
let packs = {};                      // Datenstruktur fÃ¼r alle Zellen
let HT = 0;                          // Hyper Temperatur

// Flags fÃ¼r Nachrichten
let akkuVollMsgSent = false;         // Akku voll Meldung
let lowVoltMsgSent = {};             // Unterspannung je Zelle
let hyperTempMsgSent = false;        // Ãœbertemperaturmeldung

// ==================== HILFSFUNKTIONEN ====================

// ---- Einfache URL-Encoding-Funktion (Espruino-kompatibel) ----
function simpleEncode(str) {
	let out = "";
	for (let i = 0; i < str.length; i++) {
		let ch = str.charAt(i);
		if (ch === " ") out += "%20";
		else if (ch === "Ã¶") out += "oe";
		else if (ch === "Ã¤") out += "ae";
		else if (ch === "Ã¼") out += "ue";
		else if (ch === "ÃŸ") out += "ss";
		else if (ch === "Â°") out += "%C2%B0";
		else if (ch === "%") out += "%25";
		else if (ch === "!") out += "%21";
		else if (ch === "(") out += "%28";
		else if (ch === ")") out += "%29";
		else out += ch;
	}
	return out;
}

// ---- Signal-Nachricht senden ----
function sendSignalMessage(text) {
	let safeText = simpleEncode(text);
	let url = "https://api.callmebot.com/signal/send.php" +
			  "?phone=" + signalPhone +
			  "&apikey=" + signalKey +
			  "&text=" + safeText;

	print("ðŸ“¨ Sende Signal-Nachricht: " + url);

	Shelly.call("HTTP.GET", { url: url }, function (result, error_code, error_msg) {
		if (error_code === 0) {
			print("âœ… Nachricht erfolgreich gesendet.");
		} else {
			print("âŒ Fehler beim Senden: " + error_msg);
		}
	});
}

// ---- Akku-Druckfunktion ----
function Druck(sn) {
	let daten = packs[sn];
	if (!daten) return;
	print(modus +
		  sn + ": " +
		  (daten.soc !== undefined ? daten.soc + "%" : "-%") + " " +
		  (daten.minV !== undefined ? daten.minV + "V" : "-V") + " .. " +
		  (daten.maxV !== undefined ? daten.maxV + "V" : "-V") + " " +
		  (daten.maxT !== undefined ? daten.maxT + "Â°" : "-Â°"));
}

// ---- Alle Akkus ausgeben ----
function DruckAlle() {
	for (let sn in packs) {
		Druck(sn);
	}
}

// ---- HyperTemp ausgeben ----
function DruckHyperTemp() {
	print("ðŸŒ¡ï¸ Hyper Temperatur: " + HT.toFixed(1) + " Â°C");
}

// ==================== MQTT HANDLER ====================

MQTT.subscribe(mqttTopic, function (topic, msg) {
	let data = JSON.parse(msg);

	// --- PACKDATEN ---
	if (data.packData) {
		for (let i = 0; i < data.packData.length; i++) {
			let pack = data.packData[i];
			let sn = pack.sn;

			if (!packs[sn]) {
				packs[sn] = { soc: undefined, minV: undefined, maxV: undefined, maxT: undefined };
				lowVoltMsgSent[sn] = false;
			}

			// Werte Ã¼bernehmen
			if (pack.maxVol !== undefined) packs[sn].maxV = pack.maxVol / 100;
			if (pack.minVol !== undefined) {
				packs[sn].minV = pack.minVol / 100;

				// --- Unterspannung prÃ¼fen ---
				if (packs[sn].minV < minVoltWarn) {
					if (!lowVoltMsgSent[sn]) {
						lowVoltMsgSent[sn] = true;
						sendSignalMessage("âš ï¸ Zelle " + sn + " hat nur " + packs[sn].minV + "V!");
					}
				} else if (packs[sn].minV > minVoltReset) {
					lowVoltMsgSent[sn] = false;
				}
			}
			if (pack.maxTemp !== undefined) packs[sn].maxT = pack.maxTemp - 273.1;
			if (pack.socLevel !== undefined) packs[sn].soc = pack.socLevel;

			Druck(sn);
		}
	}

	// --- PACKZUSTAND ---
	if (data.packState !== undefined) {
		if (bat !== data.packState) {
			bat = data.packState;
			switch (bat) {
				case 0: modus = "STBY "; break;
				case 1: modus = "LOAD "; break;
				case 2: modus = "UNLD "; break;
			}
			DruckAlle();
		}
	}

	// --- GESAMTLADEZUSTAND ---
	if (data.electricLevel !== undefined) {
		if (Zen !== data.electricLevel) {
			Zen = data.electricLevel;
			DruckAlle();

			if (Zen >= vollSchwelle) {
				if (!akkuVollMsgSent) {
					akkuVollMsgSent = true;
					sendSignalMessage("ðŸ”‹ Akku ist jetzt voll (" + Zen + "%)");
				}
			} else if (Zen < entladeReset) {
				akkuVollMsgSent = false;
			}
		}
	}

	// --- HYPER TEMPERATUR (global) ---
	if (data.hyperTmp !== undefined) {
		let newHT = data.hyperTmp / 10 - 273.1;
		if (HT !== newHT) {
			HT = newHT;
			DruckHyperTemp();

			if (HT > tempWarn) {
				if (!hyperTempMsgSent) {
					hyperTempMsgSent = true;
					sendSignalMessage("ðŸ”¥ Achtung! Hyper-Temperatur zu hoch: " + HT.toFixed(1) + " Â°C");
				}
			} else if (HT < tempReset) {
				hyperTempMsgSent = false;
			}
		}
	}
});

print("ðŸ“¡ MQTT-Ãœberwachung aktiv auf Topic:", mqttTopic);
sendSignalMessage("âœ… Watchdog gestartet â€“ Shelly-Ãœberwachung aktiv.");
